############################
# Zsh Configuration
############################

# Load aliases
if [[ -f "$HOME/.zsh/aliases.zsh" ]]; then
  source "$HOME/.zsh/aliases.zsh"
fi

# Load functions
if [[ -f "$HOME/.zsh/functions.zsh" ]]; then
  source "$HOME/.zsh/functions.zsh"
fi

# >>> Fast completions (static, cached)
source "$HOME/.zsh/_completions.zsh"
# <<< Fast completions

# History configuration
HISTSIZE=10000
SAVEHIST=10000
HISTFILE="${HISTFILE:-$HOME/.zsh_history}"
# Note: History-related setopt are defined in the "Zsh Shell Options" section below

############################
# Tmux Session Management
############################

# Check if we are inside a tmux session
# Only auto-start tmux if it's available and we're in an interactive shell
if [[ -z "$TMUX" && -n "$PS1" && -t 0 ]] && command -v tmux &>/dev/null; then
  # Try to attach to an existing session 'default' if it exists
  # Otherwise create a new session named 'default'
  tmux attach-session -t default 2>/dev/null || tmux new-session -s default
fi

############################
# General Environment Variables
############################

# ENABLE_WASM is intentionally empty (unset if needed)
# export ENABLE_WASM=
export EDITOR="nvim"
export VISUAL="nvim"
export SHELL='/usr/bin/zsh'

# Pager settings
export PAGER="${PAGER:-less}"
export LESS="${LESS:--R}"

# Set dotfiles directory for easy access
export DOTFILES_DIR="${DOTFILES_DIR:-$HOME/.dotfiles}"

# Language and locale settings
export LC_CTYPE=en_US.UTF-8
export LANG=en_US.UTF-8

# Timezone (if not already set)
export TZ="${TZ:-$(cat /etc/timezone 2>/dev/null || echo 'UTC')}"

# XDG Base Directory Specification support
export XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.config}"
export XDG_DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"
export XDG_CACHE_HOME="${XDG_CACHE_HOME:-$HOME/.cache}"
export XDG_STATE_HOME="${XDG_STATE_HOME:-$HOME/.local/state}"
export XDG_RUNTIME_DIR="${XDG_RUNTIME_DIR:-/run/user/$UID}"

############################
# PATH Management
############################
# Centralized PATH configuration for better maintainability
# Order matters: earlier paths take precedence

# Local user binaries (highest priority)
[[ -d "$HOME/.local/bin" ]] && export PATH="$HOME/.local/bin:$PATH"

# Cargo/Rust binaries
[[ -d "$HOME/.cargo/bin" ]] && export PATH="$HOME/.cargo/bin:$PATH"

# Mise shims (will be added by mise activate, but ensure it's in PATH)
# Note: mise activate adds its shims automatically

############################
# Zsh Shell Options (setopt/unsetopt)
############################
# This section centralizes all shell behavior modifications.
# All options are documented to clearly show what differs from zsh defaults.

# History behavior
# - HIST_IGNORE_DUPS: Don't record duplicate entries
# - HIST_FIND_NO_DUPS: Don't display duplicates when searching history
# - SHARE_HISTORY: Share history between all sessions
# - HIST_IGNORE_SPACE: Don't record commands starting with space
# - HIST_VERIFY: Show command with history expansion before running
# - HIST_SAVE_NO_DUPS: Don't write duplicate entries to history file
setopt HIST_IGNORE_DUPS
setopt HIST_FIND_NO_DUPS
setopt SHARE_HISTORY
setopt HIST_IGNORE_SPACE
setopt HIST_VERIFY
setopt HIST_SAVE_NO_DUPS

# Navigation behavior
# - AUTO_CD: Type directory name to cd into it
# - AUTO_PUSHD: Make cd push the old directory onto the directory stack
# - PUSHD_SILENT: Don't print the directory stack after pushd/popd
# - PUSHD_IGNORE_DUPS: Don't push duplicate directories onto the stack
# - CDABLE_VARS: Allow cd to variables (e.g., cd $HOME)
# - COMPLETE_IN_WORD: Complete from both ends of the word
setopt AUTO_CD
setopt AUTO_PUSHD
setopt PUSHD_SILENT
setopt PUSHD_IGNORE_DUPS
setopt CDABLE_VARS
setopt COMPLETE_IN_WORD

# Globbing and pattern matching
# - EXTENDED_GLOB: Enable extended globbing patterns (#, ~, ^)
# - NOMATCH: Print error if globbing fails to match
setopt EXTENDED_GLOB
setopt NOMATCH

# Command correction
# - CORRECT: Try to correct spelling of commands
# - CORRECT_ALL: Try to correct all arguments
# Note: These can be annoying, consider unsetting if you prefer
setopt CORRECT
setopt CORRECT_ALL

# Disable annoying behaviors
# - BEEP: Disable terminal bell/beep
# - FLOW_CONTROL: Disable flow control (Ctrl+S/Ctrl+Q)
# - MAIL_WARNING: Don't print warning if mail file has been accessed
unsetopt BEEP
unsetopt FLOW_CONTROL
unsetopt MAIL_WARNING

############################
# Language and Runtime Settings
############################

# Mise en place
export MISE_HOME="$HOME/.mise"
# Only activate mise if it exists and the activation script is available
if [[ -f ~/.local/bin/mise ]]; then
  eval "$(~/.local/bin/mise activate zsh)" 2>/dev/null || {
    echo "⚠️  Warning: mise activation failed" >&2
  }
elif command -v mise &>/dev/null; then
  eval "$(mise activate zsh)" 2>/dev/null || {
    echo "⚠️  Warning: mise activation failed" >&2
  }
fi

############################
# Zinit Plugin Manager
############################

# Install Zinit if not present
if [[ ! -f $HOME/.local/share/zinit/zinit.git/zinit.zsh ]]; then
    if ! command -v git &>/dev/null; then
        echo "⚠️  Warning: git is required to install Zinit" >&2
    else
        print -P "%F{33}Installing %F{220}ZDHARMA-CONTINUUM %F{33}Plugin Manager...%f"
        command mkdir -p "$HOME/.local/share/zinit" && command chmod g-rwX "$HOME/.local/share/zinit"
        command git clone --depth=1 https://github.com/zdharma-continuum/zinit "$HOME/.local/share/zinit/zinit.git" && \
            print -P "%F{33}✓ %F{34}Installation successful.%f" || \
            print -P "%F{160}✗ Installation failed.%f"
    fi
fi

# Load Zinit
if [[ -f "$HOME/.local/share/zinit/zinit.git/zinit.zsh" ]]; then
    source "$HOME/.local/share/zinit/zinit.git/zinit.zsh"
else
    echo "⚠️  Warning: Zinit not found. Some plugins may not work." >&2
fi
autoload -Uz _zinit
(( ${+_comps} )) && _comps[zinit]=_zinit

############################
# Completion System
############################

# Completion styling (compinit is handled by _completions.zsh)
zstyle ':completion:*' menu select
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}' 'r:|=*' 'l:|=* r:|=*'
zstyle ':completion:*' special-dirs true
zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}"

############################
# Zinit Plugins
############################

# Load Zinit annexes
zinit light-mode wait"0" lucid for \
    zdharma-continuum/zinit-annex-as-monitor \
    zdharma-continuum/zinit-annex-bin-gem-node \
    zdharma-continuum/zinit-annex-patch-dl \
    zdharma-continuum/zinit-annex-rust

# Navigation and productivity plugins
zinit wait"0" lucid for \
    blockf atpull"zinit creinstall -q ." \
    zsh-users/zsh-completions

# Syntax highlighting
zinit ice wait"0" lucid atinit"ZINIT[COMPINIT_OPTS]=-C"
zinit light zdharma-continuum/fast-syntax-highlighting

# History substring search (required for history-substring-search-up/down bindings)
zinit ice wait"0" lucid
zinit light zsh-users/zsh-history-substring-search

# Custom fzf history search (replaces plugin)
fzf-history-widget() {
  # Only define if fzf is available
  if ! command -v fzf &>/dev/null; then
    return 1
  fi

  local selected num
  setopt localoptions noglobsubst noposixbuiltins pipefail no_aliases 2>/dev/null

  # Use __fzfcmd if available, otherwise use fzf directly
  local fzf_cmd="${__fzfcmd:-fzf}"

  selected=( $(fc -rl 1 | awk '!seen[$0]++' | grep -v -E '(nim|data)' |
    FZF_DEFAULT_OPTS="--height ${FZF_TMUX_HEIGHT:-40%} $FZF_DEFAULT_OPTS --tac -n2..,.. --tiebreak=index --bind=ctrl-r:toggle-sort $FZF_CTRL_R_OPTS --query=${(q)LBUFFER} +m" $fzf_cmd) )
  local ret=$?
  if [ -n "$selected" ]; then
    num=$selected[1]
    if [ -n "$num" ]; then
      zle vi-fetch-history -n $num
    fi
  fi
  zle reset-prompt
  return $ret
}
zle     -N   fzf-history-widget
# Note: fzf-history-widget is defined but not bound by default
# Uncomment the line below to enable it (conflicts with atuin's Ctrl+R)
# bindkey '^R' fzf-history-widget

# Git tools
zinit ice wait"1" lucid
zinit light paulirish/git-open

 ############################
# Key Bindings
############################

# Navigation and history search

bindkey '^[[A' history-substring-search-up # Up arrow: search backward in history for matching substring
bindkey '^[[B' history-substring-search-down # Down arrow: search forward in history for matching substring
bindkey '^[[1;5C' forward-word   # Ctrl+Right
bindkey '^[[1;5D' backward-word  # Ctrl+Left

# Additional useful keybindings
bindkey '^U' backward-kill-line   # Ctrl+U: kill from cursor to beginning of line (bash-like)
bindkey '^[[3~' delete-char       # Delete key: delete character under cursor
bindkey '^[[1~' beginning-of-line  # Home key: go to beginning of line
bindkey '^[[4~' end-of-line       # End key: go to end of line

############################
# Local Configuration
############################

# Load local Zsh configurations from ~/.zsh.local
if [[ -d "$HOME/.zsh.local" ]]; then
  for file in "$HOME/.zsh.local"/*.zsh; do
    [[ -f "$file" ]] && source "$file"
  done
fi

############################
# PATH Additions (Tool-specific)
############################

# Pdtm - Project Discovery
# https://projectdiscovery.io/
[[ -d "$HOME/.pdtm/go/bin" ]] && export PATH="$PATH:$HOME/.pdtm/go/bin"

# Kubectl Krew
[[ -d "${KREW_ROOT:-$HOME/.krew}/bin" ]] && export PATH="${KREW_ROOT:-$HOME/.krew}/bin:$PATH"

############################
# Fuzzy Finder & Directory Navigation
############################

# General Fuzzy finder
# Only source if fzf is installed and the file exists
if command -v fzf &>/dev/null && [[ -f ~/.fzf.zsh ]]; then
  source ~/.fzf.zsh
fi

############################
# Theme Loading
############################

# Load chussenot theme (standalone, no Oh-My-Zsh required)
if [[ -f "$HOME/.zsh/themes/chussenot.zsh-theme" ]]; then
    source "$HOME/.zsh/themes/chussenot.zsh-theme"
elif [[ -f "$DOTFILES_DIR/configs/shell/chussenot.zsh-theme" ]]; then
    source "$DOTFILES_DIR/configs/shell/chussenot.zsh-theme"
fi

# Ensure EDITOR is set to nvim
export EDITOR="nvim"
export VISUAL="nvim"

############################
# Atuin
############################

if command -v atuin >/dev/null 2>&1; then
  eval "$(atuin init zsh)"
fi

############################
# zoxide
############################

if command -v zoxide >/dev/null 2>&1; then
  eval "$(zoxide init zsh)"
fi

# Note: bashcompinit is already handled in _completions.zsh
# Only set MANPATH here
[[ -d "$HOME/.local/share/man" ]] && export MANPATH="$HOME/.local/share/man:$MANPATH"

############################
# Performance Profiling (optional)
############################
# Uncomment to profile zsh startup time
# Uncomment the lines below and run: zsh -i -c exit
# zmodload zsh/zprof
# zprof
